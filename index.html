<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#0F0F1A">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>üí∏ B√ºt√ße Takip</title>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Outfit', -apple-system, sans-serif;
      background: linear-gradient(135deg, #0F0F1A 0%, #1A1A2E 50%, #16213E 100%);
      min-height: 100vh;
      color: #E8E8E8;
    }
    .hidden { display: none !important; }
    .container { max-width: 1200px; margin: 0 auto; padding: 16px; }
    
    /* Login */
    .login-page {
      min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px;
    }
    .login-box {
      background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08);
      border-radius: 24px; padding: 40px 32px; width: 100%; max-width: 380px;
    }
    .login-title { text-align: center; margin-bottom: 32px; }
    .login-title .icon { font-size: 48px; margin-bottom: 12px; }
    .login-title h1 { font-size: 24px; font-weight: 700; margin-bottom: 8px; }
    .login-title p { color: rgba(255,255,255,0.5); font-size: 14px; }
    
    .form-group { margin-bottom: 16px; }
    .form-group label { display: block; margin-bottom: 8px; font-size: 13px; color: rgba(255,255,255,0.6); }
    .form-group input {
      width: 100%; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px; padding: 14px 16px; color: white; font-family: 'Outfit', sans-serif; font-size: 15px;
    }
    .form-group input:focus { outline: none; border-color: #6366F1; background: rgba(99,102,241,0.1); }
    .form-group input::placeholder { color: rgba(255,255,255,0.3); }
    
    .error-msg {
      background: rgba(239,68,68,0.2); border: 1px solid rgba(239,68,68,0.3);
      border-radius: 10px; padding: 12px; margin-bottom: 16px; color: #EF4444; font-size: 13px; text-align: center;
    }
    
    .btn-primary {
      width: 100%; background: linear-gradient(135deg, #6366F1 0%, #8B5CF6 100%);
      border: none; color: white; font-family: 'Outfit', sans-serif; font-size: 16px; font-weight: 600;
      padding: 14px; border-radius: 12px; cursor: pointer;
    }
    .btn-primary:hover { opacity: 0.9; }
    
    .cloud-note {
      margin-top: 20px; padding: 12px; background: rgba(34,197,94,0.1);
      border-radius: 10px; text-align: center; font-size: 12px; color: rgba(255,255,255,0.5);
    }
    
    /* Header */
    .header {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 24px; flex-wrap: wrap; gap: 16px;
    }
    .header-title h1 { font-size: 24px; font-weight: 700; margin-bottom: 2px; }
    .header-title p { color: rgba(255,255,255,0.4); font-size: 12px; }
    .header-controls { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    
    /* Buttons */
    .btn {
      border: none; font-family: 'Outfit', sans-serif; font-weight: 500;
      padding: 8px 12px; border-radius: 8px; cursor: pointer; font-size: 12px;
    }
    .btn-add {
      background: linear-gradient(135deg, #6366F1 0%, #8B5CF6 100%);
      color: white; padding: 12px 20px; border-radius: 14px; font-size: 14px; font-weight: 600;
    }
    .btn-logout {
      background: rgba(239,68,68,0.2); border: 1px solid rgba(239,68,68,0.3); color: #EF4444;
    }
    
    /* Account selector */
    .account-selector {
      display: flex; gap: 6px; background: rgba(255,255,255,0.03);
      padding: 4px; border-radius: 12px;
    }
    .account-btn {
      display: flex; flex-direction: column; align-items: center; gap: 2px;
      padding: 8px 12px; border-radius: 10px; border: 1px solid transparent;
      background: transparent; color: rgba(255,255,255,0.5);
      font-family: 'Outfit', sans-serif; font-size: 11px; cursor: pointer; min-width: 60px;
    }
    .account-btn.active { background: rgba(99,102,241,0.2); border-color: rgba(99,102,241,0.4); color: white; }
    .account-btn .icon { font-size: 16px; }
    .account-btn .balance { font-family: 'Space Mono', monospace; font-size: 9px; }
    .balance-positive { color: #22C55E; }
    .balance-negative { color: #EF4444; }
    
    /* Currency selector */
    .currency-selector { display: flex; flex-direction: column; align-items: center; gap: 4px; }
    .currency-buttons { display: flex; gap: 4px; background: rgba(255,255,255,0.05); padding: 4px; border-radius: 10px; }
    .currency-btn {
      display: flex; align-items: center; gap: 4px; padding: 8px 10px; border-radius: 8px;
      border: none; background: transparent; color: rgba(255,255,255,0.5);
      font-family: 'Outfit', sans-serif; font-size: 12px; cursor: pointer;
    }
    .currency-btn.active { background: rgba(99,102,241,0.3); color: white; }
    .currency-btn .flag { font-size: 14px; }
    .rate-info { font-size: 9px; color: rgba(255,255,255,0.4); font-family: 'Space Mono', monospace; }
    .rate-live { color: rgba(34,197,94,0.8); }
    
    /* Cards */
    .cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 12px; margin-bottom: 24px; }
    .card {
      background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08);
      border-radius: 20px; padding: 20px; position: relative; overflow: hidden;
    }
    .card::before {
      content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px;
      background: var(--card-color); opacity: 0.8;
    }
    .card-header { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; }
    .card-icon { font-size: 24px; }
    .card-label { color: rgba(255,255,255,0.6); font-size: 12px; }
    .card-value { font-size: 22px; font-weight: 700; font-family: 'Space Mono', monospace; }
    
    /* Tabs */
    .tabs {
      display: flex; gap: 6px; margin-bottom: 20px; background: rgba(255,255,255,0.03);
      padding: 4px; border-radius: 14px; width: fit-content;
    }
    .tab-btn {
      background: transparent; border: none; color: rgba(255,255,255,0.5);
      font-family: 'Outfit', sans-serif; font-size: 13px; font-weight: 500;
      padding: 10px 16px; border-radius: 10px; cursor: pointer;
    }
    .tab-btn.active { background: rgba(99,102,241,0.2); color: white; }
    
    /* Content box */
    .content-box {
      background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08);
      border-radius: 20px; padding: 20px;
    }
    .content-box h3 { font-size: 16px; font-weight: 600; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
    .content-box h3 .icon { font-size: 20px; }
    
    .distribution-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px; }
    
    /* Legend item */
    .legend-item {
      display: flex; align-items: center; gap: 10px; padding: 8px 12px;
      background: rgba(255,255,255,0.03); border-radius: 10px; margin-bottom: 6px;
    }
    .legend-dot { width: 10px; height: 10px; border-radius: 50%; }
    .legend-icon { font-size: 16px; }
    .legend-name { flex: 1; font-size: 13px; }
    .legend-value { font-family: 'Space Mono', monospace; font-size: 12px; color: rgba(255,255,255,0.6); }
    
    /* Filter */
    .filter-bar { display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; }
    .filter-btn {
      background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
      color: rgba(255,255,255,0.6); font-family: 'Outfit', sans-serif; font-size: 12px;
      padding: 6px 12px; border-radius: 16px; cursor: pointer;
    }
    .filter-btn.active { background: rgba(99,102,241,0.2); border-color: #6366F1; color: white; }
    
    /* Transaction */
    .transaction-list { max-height: 400px; overflow-y: auto; }
    .transaction-item {
      display: flex; align-items: center; padding: 14px 16px;
      background: rgba(255,255,255,0.02); border-radius: 14px; margin-bottom: 8px;
    }
    .transaction-icon {
      width: 40px; height: 40px; border-radius: 12px;
      display: flex; align-items: center; justify-content: center; font-size: 18px; margin-right: 12px;
    }
    .transaction-info { flex: 1; }
    .transaction-title { font-weight: 500; font-size: 14px; margin-bottom: 2px; }
    .transaction-meta { font-size: 11px; color: rgba(255,255,255,0.4); display: flex; gap: 6px; flex-wrap: wrap; }
    .transaction-tag { background: rgba(255,255,255,0.1); padding: 1px 6px; border-radius: 4px; font-size: 10px; }
    .transaction-amount { font-family: 'Space Mono', monospace; font-weight: 600; font-size: 14px; margin-right: 8px; }
    .transaction-amount.income { color: #22C55E; }
    .transaction-amount.expense { color: #EF4444; }
    .transaction-delete {
      background: transparent; border: none; color: rgba(255,255,255,0.3);
      cursor: pointer; padding: 8px; font-size: 16px;
    }
    .transaction-delete:hover { color: #EF4444; }
    
    .empty-state { text-align: center; padding: 40px 20px; color: rgba(255,255,255,0.4); }
    .empty-state .icon { font-size: 40px; margin-bottom: 12px; }
    
    /* Modal */
    .modal-overlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.8); display: flex; align-items: center;
      justify-content: center; z-index: 1000; padding: 16px;
    }
    .modal-content {
      background: linear-gradient(135deg, #1A1A2E 0%, #16213E 100%);
      border: 1px solid rgba(255,255,255,0.1); border-radius: 24px;
      padding: 24px; width: 100%; max-width: 420px; max-height: 90vh; overflow-y: auto;
    }
    .modal-title { font-size: 20px; font-weight: 600; margin-bottom: 20px; text-align: center; }
    
    /* Type toggle */
    .type-toggle { display: flex; background: rgba(255,255,255,0.05); border-radius: 12px; padding: 4px; gap: 4px; margin-bottom: 16px; }
    .type-btn {
      flex: 1; padding: 12px; border: none; border-radius: 10px;
      font-family: 'Outfit', sans-serif; font-size: 14px; font-weight: 500;
      cursor: pointer; background: transparent; color: rgba(255,255,255,0.5);
    }
    .type-btn.active.expense { background: rgba(239,68,68,0.3); color: white; }
    .type-btn.active.income { background: rgba(34,197,94,0.3); color: white; }
    
    /* Account toggle */
    .account-toggle { display: flex; gap: 8px; margin-bottom: 16px; }
    .account-toggle-btn {
      flex: 1; display: flex; align-items: center; justify-content: center; gap: 6px;
      padding: 12px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.1);
      background: rgba(255,255,255,0.02); color: rgba(255,255,255,0.5);
      font-family: 'Outfit', sans-serif; font-size: 13px; cursor: pointer;
    }
    .account-toggle-btn.active { border-color: var(--acc-color); background: var(--acc-bg); color: white; }
    
    /* Category grid */
    .category-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 16px; }
    .category-btn {
      padding: 10px 6px; border: 1px solid rgba(255,255,255,0.1); border-radius: 10px;
      background: rgba(255,255,255,0.02); color: rgba(255,255,255,0.7);
      font-family: 'Outfit', sans-serif; font-size: 11px; cursor: pointer;
      display: flex; flex-direction: column; align-items: center; gap: 4px;
    }
    .category-btn:hover { background: rgba(255,255,255,0.08); }
    .category-btn.active { border-color: var(--cat-color); background: var(--cat-bg); color: white; }
    .category-btn .icon { font-size: 18px; }
    
    /* Modal buttons */
    .modal-actions { display: flex; gap: 10px; }
    .modal-btn {
      flex: 1; padding: 14px; border-radius: 12px; font-family: 'Outfit', sans-serif;
      font-size: 14px; cursor: pointer;
    }
    .modal-btn-cancel {
      background: transparent; border: 1px solid rgba(255,255,255,0.1); color: rgba(255,255,255,0.6);
    }
    .modal-btn-save {
      flex: 2; background: linear-gradient(135deg, #6366F1 0%, #8B5CF6 100%);
      border: none; color: white; font-weight: 600;
    }
    .modal-btn-save:disabled { background: rgba(255,255,255,0.1); color: rgba(255,255,255,0.3); cursor: not-allowed; }
    
    /* Sync indicator */
    .sync-indicator {
      position: fixed; top: 16px; right: 16px; background: rgba(99,102,241,0.9);
      padding: 8px 16px; border-radius: 20px; display: flex; align-items: center;
      gap: 8px; z-index: 1001; font-size: 13px;
    }
    
    /* Loading */
    .loading-page {
      min-height: 100vh; display: flex; align-items: center; justify-content: center;
      flex-direction: column; gap: 16px;
    }
    
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .spinner {
      width: 40px; height: 40px; border: 3px solid rgba(99,102,241,0.3);
      border-top-color: #6366F1; border-radius: 50%; animation: spin 1s linear infinite;
    }
    .spinner-small { width: 14px; height: 14px; border-width: 2px; }
  </style>
</head>
<body>
  
  <!-- Login Page -->
  <div id="loginPage" class="login-page">
    <div class="login-box">
      <div class="login-title">
        <div class="icon">üí∏</div>
        <h1>B√ºt√ße Takip</h1>
        <p>Giri≈ü yaparak devam edin</p>
      </div>
      
      <div class="form-group">
        <label>Kullanƒ±cƒ± Adƒ±</label>
        <input type="text" id="username" placeholder="Kullanƒ±cƒ± adƒ±nƒ±zƒ± girin">
      </div>
      
      <div class="form-group">
        <label>≈ûifre</label>
        <input type="password" id="password" placeholder="≈ûifrenizi girin">
      </div>
      
      <div id="loginError" class="error-msg hidden"></div>
      
      <button class="btn-primary" onclick="handleLogin()">Giri≈ü Yap</button>
      
      <div class="cloud-note">‚òÅÔ∏è Verileriniz bulutta saklanƒ±r</div>
    </div>
  </div>
  
  <!-- Loading Page -->
  <div id="loadingPage" class="loading-page hidden">
    <div class="spinner"></div>
    <p style="color: rgba(255,255,255,0.6);">Veriler y√ºkleniyor...</p>
  </div>
  
  <!-- Main App -->
  <div id="mainApp" class="container hidden">
    
    <!-- Sync Indicator -->
    <div id="syncIndicator" class="sync-indicator hidden">
      <div class="spinner spinner-small"></div>
      Kaydediliyor...
    </div>
    
    <!-- Header -->
    <header class="header">
      <div class="header-title">
        <h1>üí∏ B√ºt√ße Takip</h1>
        <p id="userInfo">‚òÅÔ∏è Y√ºkleniyor...</p>
      </div>
      
      <div class="header-controls">
        <!-- Account Selector -->
        <div class="account-selector" id="accountSelector"></div>
        
        <!-- Add Button -->
        <button class="btn btn-add" onclick="openModal()">‚ûï Yeni</button>
        
        <!-- Currency Selector -->
        <div class="currency-selector">
          <div class="currency-buttons" id="currencyButtons"></div>
          <div class="rate-info" id="rateInfo"></div>
        </div>
        
        <!-- Logout -->
        <button class="btn btn-logout" onclick="handleLogout()">üö™ √áƒ±kƒ±≈ü</button>
      </div>
    </header>
    
    <!-- Cards -->
    <div class="cards" id="summaryCards"></div>
    
    <!-- Tabs -->
    <div class="tabs">
      <button class="tab-btn active" id="tabOverview" onclick="switchTab('overview')">üìä Genel Bakƒ±≈ü</button>
      <button class="tab-btn" id="tabTransactions" onclick="switchTab('transactions')">üìã ƒ∞≈ülemler</button>
    </div>
    
    <!-- Overview Content -->
    <div id="overviewContent" class="distribution-grid"></div>
    
    <!-- Transactions Content -->
    <div id="transactionsContent" class="content-box hidden"></div>
  </div>
  
  <!-- Add Modal -->
  <div id="addModal" class="modal-overlay hidden" onclick="closeModal()">
    <div class="modal-content" onclick="event.stopPropagation()">
      <h2 class="modal-title">‚ú® Yeni ƒ∞≈ülem Ekle</h2>
      
      <!-- Type Toggle -->
      <div class="type-toggle">
        <button class="type-btn expense active" id="typeExpense" onclick="setType('expense')">üí∏ Gider</button>
        <button class="type-btn income" id="typeIncome" onclick="setType('income')">üí∞ Gelir</button>
      </div>
      
      <!-- Amount -->
      <div class="form-group">
        <label>Tutar (<span id="currencySymbol">‚Ç∫</span>)</label>
        <input type="number" id="amount" placeholder="0" style="font-size: 24px; text-align: center; font-family: 'Space Mono', monospace;">
      </div>
      
      <!-- Account -->
      <div class="form-group">
        <label>Hesap</label>
        <div class="account-toggle" id="accountToggle"></div>
      </div>
      
      <!-- Category -->
      <div class="form-group">
        <label>Kategori</label>
        <div class="category-grid" id="categoryGrid"></div>
      </div>
      
      <!-- Description -->
      <div class="form-group">
        <label>A√ßƒ±klama (Opsiyonel)</label>
        <input type="text" id="description" placeholder="√ñrn: Haftalƒ±k market">
      </div>
      
      <!-- Date -->
      <div class="form-group">
        <label>Tarih</label>
        <input type="date" id="date">
      </div>
      
      <!-- Actions -->
      <div class="modal-actions">
        <button class="modal-btn modal-btn-cancel" onclick="closeModal()">ƒ∞ptal</button>
        <button class="modal-btn modal-btn-save" id="saveBtn" onclick="saveTransaction()">Kaydet</button>
      </div>
    </div>
  </div>

  <!-- Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  
  <script>
    // Supabase
    const supabaseUrl = 'https://aveuyrpkdzyiadkjwjca.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF2ZXV5cnBrZHp5aWFka2p3amNhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc0NjA0NzMsImV4cCI6MjA4MzAzNjQ3M30.R85z7ls1uixVDeV5YPzxM1jQVV-KQweP6hNMCOWKuCA';
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
    
    // Data
    const EXPENSE_CATEGORIES = [
      { id: 'market', name: 'Market & Gƒ±da', color: '#E63946', icon: 'üõí' },
      { id: 'fatura', name: 'Faturalar', color: '#457B9D', icon: 'üìÑ' },
      { id: 'ulasim', name: 'Ula≈üƒ±m', color: '#2A9D8F', icon: 'üöó' },
      { id: 'saglik', name: 'Saƒülƒ±k', color: '#E9C46A', icon: 'üíä' },
      { id: 'eglence', name: 'Eƒülence', color: '#F4A261', icon: 'üé¨' },
      { id: 'giyim', name: 'Giyim', color: '#9B5DE5', icon: 'üëï' },
      { id: 'egitim', name: 'Eƒüitim', color: '#00BBF9', icon: 'üìö' },
      { id: 'kira', name: 'Kira', color: '#F15BB5', icon: 'üè†' },
      { id: 'diger', name: 'Diƒüer', color: '#6C757D', icon: 'üì¶' },
    ];
    
    const INCOME_CATEGORIES = [
      { id: 'maas', name: 'Maa≈ü', color: '#06D6A0', icon: 'üí∞' },
      { id: 'ek_gelir', name: 'Ek Gelir', color: '#118AB2', icon: 'üíµ' },
      { id: 'yatirim', name: 'Yatƒ±rƒ±m Getirisi', color: '#FFD166', icon: 'üìà' },
      { id: 'hediye', name: 'Hediye', color: '#EF476F', icon: 'üéÅ' },
      { id: 'diger_gelir', name: 'Diƒüer', color: '#073B4C', icon: '‚ú®' },
    ];
    
    const CURRENCIES = [
      { code: 'TRY', symbol: '‚Ç∫', flag: 'üáπüá∑', locale: 'tr-TR' },
      { code: 'USD', symbol: '$', flag: 'üá∫üá∏', locale: 'en-US' },
      { code: 'RUB', symbol: '‚ÇΩ', flag: 'üá∑üá∫', locale: 'ru-RU' },
    ];
    
    const ACCOUNTS = [
      { id: 'all', name: 'T√ºm√º', icon: 'üìä', color: '#6366F1' },
      { id: 'cash', name: 'Nakit', icon: 'üíµ', color: '#22C55E' },
      { id: 'bank', name: 'Banka', icon: 'üè¶', color: '#3B82F6' },
    ];
    
    // State
    let currentUser = '';
    let transactions = [];
    let selectedCurrency = 'TRY';
    let selectedAccount = 'all';
    let filterType = 'all';
    let activeTab = 'overview';
    let exchangeRates = { TRY: 1, USD: 42.96, RUB: 0.54 };
    let ratesLive = false;
    
    // New transaction state
    let newType = 'expense';
    let newAccount = 'cash';
    let newCategory = '';
    
    // Auth
    const VALID_USER = 'admin';
    const VALID_PASS = 'admin9913';
    
    // Init
    document.addEventListener('DOMContentLoaded', function() {
      // Check login
      if (localStorage.getItem('butce_logged_in') === 'true') {
        currentUser = localStorage.getItem('butce_current_user') || '';
        if (currentUser) {
          showLoading();
          loadData();
        }
      }
      
      // Set today's date
      document.getElementById('date').value = new Date().toISOString().split('T')[0];
      
      // Enter key for login
      document.getElementById('password').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') handleLogin();
      });
      document.getElementById('username').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') document.getElementById('password').focus();
      });
      
      // Fetch rates
      fetchRates();
    });
    
    // Fetch exchange rates
    async function fetchRates() {
      try {
        const res = await fetch('https://api.exchangerate-api.com/v4/latest/TRY');
        const data = await res.json();
        exchangeRates = {
          TRY: 1,
          USD: 1 / data.rates.USD,
          RUB: 1 / data.rates.RUB,
        };
        ratesLive = true;
        updateRateInfo();
      } catch(e) {
        console.log('Rate fetch error:', e);
      }
    }
    
    // Login
    function handleLogin() {
      const user = document.getElementById('username').value;
      const pass = document.getElementById('password').value;
      
      if (user === VALID_USER && pass === VALID_PASS) {
        currentUser = user;
        localStorage.setItem('butce_logged_in', 'true');
        localStorage.setItem('butce_current_user', user);
        document.getElementById('loginError').classList.add('hidden');
        showLoading();
        loadData();
      } else {
        document.getElementById('loginError').textContent = '‚ö†Ô∏è Kullanƒ±cƒ± adƒ± veya ≈üifre hatalƒ±!';
        document.getElementById('loginError').classList.remove('hidden');
      }
    }
    
    // Logout
    function handleLogout() {
      currentUser = '';
      transactions = [];
      localStorage.setItem('butce_logged_in', 'false');
      localStorage.removeItem('butce_current_user');
      document.getElementById('mainApp').classList.add('hidden');
      document.getElementById('loginPage').classList.remove('hidden');
      document.getElementById('username').value = '';
      document.getElementById('password').value = '';
    }
    
    // Show loading
    function showLoading() {
      document.getElementById('loginPage').classList.add('hidden');
      document.getElementById('loadingPage').classList.remove('hidden');
    }
    
    // Load data
    async function loadData() {
      try {
        const { data, error } = await supabase
          .from('transactions')
          .select('*')
          .eq('user_id', currentUser)
          .order('date', { ascending: false });
        
        if (error) throw error;
        transactions = data || [];
      } catch(e) {
        console.error('Load error:', e);
        transactions = [];
      }
      
      document.getElementById('loadingPage').classList.add('hidden');
      document.getElementById('mainApp').classList.remove('hidden');
      renderApp();
    }
    
    // Format currency
    function formatCurrency(amount, code) {
      code = code || selectedCurrency;
      const cur = CURRENCIES.find(c => c.code === code);
      const converted = code === 'TRY' ? amount : amount / exchangeRates[code];
      return new Intl.NumberFormat(cur.locale, {
        style: 'currency',
        currency: code,
        minimumFractionDigits: code === 'TRY' ? 0 : 2,
        maximumFractionDigits: code === 'TRY' ? 0 : 2,
      }).format(converted);
    }
    
    // Format date
    function formatDate(date) {
      return new Date(date).toLocaleDateString('tr-TR', { day: 'numeric', month: 'short' });
    }
    
    // Calculate balances
    function getBalances() {
      const filtered = selectedAccount === 'all' ? transactions : transactions.filter(t => t.account === selectedAccount);
      const income = filtered.filter(t => t.type === 'income').reduce((s, t) => s + parseFloat(t.amount), 0);
      const expense = filtered.filter(t => t.type === 'expense').reduce((s, t) => s + parseFloat(t.amount), 0);
      const cash = transactions.filter(t => t.account === 'cash').reduce((s, t) => t.type === 'income' ? s + parseFloat(t.amount) : s - parseFloat(t.amount), 0);
      const bank = transactions.filter(t => t.account === 'bank').reduce((s, t) => t.type === 'income' ? s + parseFloat(t.amount) : s - parseFloat(t.amount), 0);
      return { income, expense, balance: income - expense, cash, bank };
    }
    
    // Render app
    function renderApp() {
      const bal = getBalances();
      
      // User info
      document.getElementById('userInfo').textContent = '‚òÅÔ∏è ' + currentUser + ' olarak giri≈ü yapƒ±ldƒ±';
      
      // Account selector
      let accHtml = '';
      ACCOUNTS.forEach(acc => {
        const isActive = selectedAccount === acc.id;
        let balanceHtml = '';
        if (acc.id === 'cash') {
          balanceHtml = '<span class="balance ' + (bal.cash >= 0 ? 'balance-positive' : 'balance-negative') + '">' + formatCurrency(bal.cash) + '</span>';
        } else if (acc.id === 'bank') {
          balanceHtml = '<span class="balance ' + (bal.bank >= 0 ? 'balance-positive' : 'balance-negative') + '">' + formatCurrency(bal.bank) + '</span>';
        }
        accHtml += '<button class="account-btn ' + (isActive ? 'active' : '') + '" onclick="setAccount(\'' + acc.id + '\')">' +
          '<span class="icon">' + acc.icon + '</span>' +
          '<span>' + acc.name + '</span>' +
          balanceHtml +
          '</button>';
      });
      document.getElementById('accountSelector').innerHTML = accHtml;
      
      // Currency buttons
      let curHtml = '';
      CURRENCIES.forEach(cur => {
        const isActive = selectedCurrency === cur.code;
        curHtml += '<button class="currency-btn ' + (isActive ? 'active' : '') + '" onclick="setCurrency(\'' + cur.code + '\')">' +
          '<span class="flag">' + cur.flag + '</span>' + cur.code +
          '</button>';
      });
      document.getElementById('currencyButtons').innerHTML = curHtml;
      updateRateInfo();
      
      // Summary cards
      const cards = [
        { label: 'Bakiye', value: bal.balance, color: '#6366F1', icon: 'üëõ', valueColor: bal.balance >= 0 ? '#22C55E' : '#EF4444' },
        { label: 'Gelir', value: bal.income, color: '#22C55E', icon: 'üìà', valueColor: '#22C55E' },
        { label: 'Gider', value: bal.expense, color: '#EF4444', icon: 'üìâ', valueColor: '#EF4444' },
      ];
      let cardsHtml = '';
      cards.forEach(card => {
        cardsHtml += '<div class="card" style="--card-color: ' + card.color + '">' +
          '<div class="card-header"><span class="card-icon">' + card.icon + '</span><span class="card-label">' + card.label + '</span></div>' +
          '<div class="card-value" style="color: ' + card.valueColor + '">' + formatCurrency(card.value) + '</div>' +
          '</div>';
      });
      document.getElementById('summaryCards').innerHTML = cardsHtml;
      
      // Render active tab
      if (activeTab === 'overview') {
        renderOverview();
      } else {
        renderTransactions();
      }
    }
    
    // Update rate info
    function updateRateInfo() {
      document.getElementById('rateInfo').innerHTML = 'üí± 1$ = ‚Ç∫' + exchangeRates.USD.toFixed(2) + 
        ' &nbsp; 1‚ÇΩ = ‚Ç∫' + exchangeRates.RUB.toFixed(2) + 
        (ratesLive ? ' <span class="rate-live">‚úì Canlƒ±</span>' : '');
    }
    
    // Render overview
    function renderOverview() {
      const filtered = selectedAccount === 'all' ? transactions : transactions.filter(t => t.account === selectedAccount);
      
      // Expense by category
      const expenseByCat = EXPENSE_CATEGORIES.map(cat => ({
        ...cat,
        value: filtered.filter(t => t.type === 'expense' && t.category === cat.id).reduce((s, t) => s + parseFloat(t.amount), 0)
      })).filter(c => c.value > 0);
      
      // Income by category
      const incomeByCat = INCOME_CATEGORIES.map(cat => ({
        ...cat,
        value: filtered.filter(t => t.type === 'income' && t.category === cat.id).reduce((s, t) => s + parseFloat(t.amount), 0)
      })).filter(c => c.value > 0);
      
      let html = '';
      
      // Expense box
      html += '<div class="content-box"><h3><span class="icon">üì§</span> Gider Daƒüƒ±lƒ±mƒ±</h3>';
      if (expenseByCat.length > 0) {
        expenseByCat.forEach(cat => {
          html += '<div class="legend-item">' +
            '<div class="legend-dot" style="background: ' + cat.color + '"></div>' +
            '<span class="legend-icon">' + cat.icon + '</span>' +
            '<span class="legend-name">' + cat.name + '</span>' +
            '<span class="legend-value">' + formatCurrency(cat.value) + '</span>' +
            '</div>';
        });
      } else {
        html += '<div class="empty-state">Hen√ºz gider kaydƒ± yok</div>';
      }
      html += '</div>';
      
      // Income box
      html += '<div class="content-box"><h3><span class="icon">üì•</span> Gelir Daƒüƒ±lƒ±mƒ±</h3>';
      if (incomeByCat.length > 0) {
        incomeByCat.forEach(cat => {
          html += '<div class="legend-item">' +
            '<div class="legend-dot" style="background: ' + cat.color + '"></div>' +
            '<span class="legend-icon">' + cat.icon + '</span>' +
            '<span class="legend-name">' + cat.name + '</span>' +
            '<span class="legend-value">' + formatCurrency(cat.value) + '</span>' +
            '</div>';
        });
      } else {
        html += '<div class="empty-state">Hen√ºz gelir kaydƒ± yok</div>';
      }
      html += '</div>';
      
      document.getElementById('overviewContent').innerHTML = html;
      document.getElementById('overviewContent').classList.remove('hidden');
      document.getElementById('transactionsContent').classList.add('hidden');
    }
    
    // Render transactions
    function renderTransactions() {
      const filtered = transactions.filter(t => {
        const typeMatch = filterType === 'all' || t.type === filterType;
        const accMatch = selectedAccount === 'all' || t.account === selectedAccount;
        return typeMatch && accMatch;
      }).sort((a, b) => new Date(b.date) - new Date(a.date));
      
      let html = '';
      
      // Filter bar
      html += '<div class="filter-bar">';
      [{ id: 'all', label: 'T√ºm√º' }, { id: 'income', label: 'üí∞ Gelirler' }, { id: 'expense', label: 'üí∏ Giderler' }].forEach(f => {
        html += '<button class="filter-btn ' + (filterType === f.id ? 'active' : '') + '" onclick="setFilter(\'' + f.id + '\')">' + f.label + '</button>';
      });
      html += '</div>';
      
      // Transaction list
      html += '<div class="transaction-list">';
      if (filtered.length > 0) {
        filtered.forEach(t => {
          const catList = t.type === 'income' ? INCOME_CATEGORIES : EXPENSE_CATEGORIES;
          const cat = catList.find(c => c.id === t.category) || { icon: '‚ùì', name: 'Bilinmiyor', color: '#666' };
          const acc = ACCOUNTS.find(a => a.id === t.account) || ACCOUNTS[0];
          
          html += '<div class="transaction-item">' +
            '<div class="transaction-icon" style="background: ' + cat.color + '22">' + cat.icon + '</div>' +
            '<div class="transaction-info">' +
            '<div class="transaction-title">' + (t.description || cat.name) + '</div>' +
            '<div class="transaction-meta">üìÖ ' + formatDate(t.date) + 
            ' <span class="transaction-tag" style="background: ' + acc.color + '30">' + acc.icon + ' ' + acc.name + '</span></div>' +
            '</div>' +
            '<div class="transaction-amount ' + t.type + '">' + (t.type === 'income' ? '+' : '-') + formatCurrency(parseFloat(t.amount)) + '</div>' +
            '<button class="transaction-delete" onclick="deleteTransaction(' + t.id + ')">üóëÔ∏è</button>' +
            '</div>';
        });
      } else {
        html += '<div class="empty-state"><div class="icon">üì≠</div><p>Hen√ºz i≈ülem kaydƒ± yok</p></div>';
      }
      html += '</div>';
      
      document.getElementById('transactionsContent').innerHTML = html;
      document.getElementById('transactionsContent').classList.remove('hidden');
      document.getElementById('overviewContent').classList.add('hidden');
    }
    
    // Set account
    function setAccount(acc) {
      selectedAccount = acc;
      renderApp();
    }
    
    // Set currency
    function setCurrency(cur) {
      selectedCurrency = cur;
      localStorage.setItem('butce_currency', cur);
      renderApp();
    }
    
    // Set filter
    function setFilter(type) {
      filterType = type;
      renderTransactions();
    }
    
    // Switch tab
    function switchTab(tab) {
      activeTab = tab;
      document.getElementById('tabOverview').classList.toggle('active', tab === 'overview');
      document.getElementById('tabTransactions').classList.toggle('active', tab === 'transactions');
      if (tab === 'overview') {
        renderOverview();
      } else {
        renderTransactions();
      }
    }
    
    // Modal functions
    function openModal() {
      newType = 'expense';
      newAccount = 'cash';
      newCategory = '';
      document.getElementById('amount').value = '';
      document.getElementById('description').value = '';
      document.getElementById('date').value = new Date().toISOString().split('T')[0];
      renderModal();
      document.getElementById('addModal').classList.remove('hidden');
    }
    
    function closeModal() {
      document.getElementById('addModal').classList.add('hidden');
    }
    
    function renderModal() {
      // Type buttons
      document.getElementById('typeExpense').className = 'type-btn expense ' + (newType === 'expense' ? 'active' : '');
      document.getElementById('typeIncome').className = 'type-btn income ' + (newType === 'income' ? 'active' : '');
      
      // Currency symbol
      const cur = CURRENCIES.find(c => c.code === selectedCurrency);
      document.getElementById('currencySymbol').textContent = cur.symbol;
      
      // Account toggle
      let accHtml = '';
      ACCOUNTS.filter(a => a.id !== 'all').forEach(acc => {
        const isActive = newAccount === acc.id;
        accHtml += '<button class="account-toggle-btn ' + (isActive ? 'active' : '') + '" ' +
          'style="--acc-color: ' + acc.color + '; --acc-bg: ' + acc.color + '25" ' +
          'onclick="setNewAccount(\'' + acc.id + '\')">' +
          '<span>' + acc.icon + '</span>' + acc.name +
          '</button>';
      });
      document.getElementById('accountToggle').innerHTML = accHtml;
      
      // Categories
      const cats = newType === 'income' ? INCOME_CATEGORIES : EXPENSE_CATEGORIES;
      let catHtml = '';
      cats.forEach(cat => {
        const isActive = newCategory === cat.id;
        catHtml += '<button class="category-btn ' + (isActive ? 'active' : '') + '" ' +
          'style="--cat-color: ' + cat.color + '; --cat-bg: ' + cat.color + '20" ' +
          'onclick="setNewCategory(\'' + cat.id + '\')">' +
          '<span class="icon">' + cat.icon + '</span>' + cat.name +
          '</button>';
      });
      document.getElementById('categoryGrid').innerHTML = catHtml;
      
      // Save button state
      updateSaveButton();
    }
    
    function setType(type) {
      newType = type;
      newCategory = '';
      renderModal();
    }
    
    function setNewAccount(acc) {
      newAccount = acc;
      renderModal();
    }
    
    function setNewCategory(cat) {
      newCategory = cat;
      renderModal();
    }
    
    function updateSaveButton() {
      const amount = document.getElementById('amount').value;
      const canSave = newCategory && amount && parseFloat(amount) > 0;
      document.getElementById('saveBtn').disabled = !canSave;
    }
    
    // Add event listener for amount input
    document.getElementById('amount').addEventListener('input', updateSaveButton);
    
    // Save transaction
    async function saveTransaction() {
      const amount = document.getElementById('amount').value;
      const description = document.getElementById('description').value;
      const date = document.getElementById('date').value;
      
      if (!newCategory || !amount) return;
      
      document.getElementById('syncIndicator').classList.remove('hidden');
      document.getElementById('saveBtn').disabled = true;
      
      try {
        const { data, error } = await supabase
          .from('transactions')
          .insert([{
            user_id: currentUser,
            type: newType,
            category: newCategory,
            amount: parseFloat(amount),
            description: description,
            date: date,
            account: newAccount,
          }])
          .select()
          .single();
        
        if (error) throw error;
        
        transactions.unshift(data);
        closeModal();
        renderApp();
      } catch(e) {
        alert('Kaydetme hatasƒ±: ' + e.message);
        console.error(e);
      }
      
      document.getElementById('syncIndicator').classList.add('hidden');
    }
    
    // Delete transaction
    async function deleteTransaction(id) {
      if (!confirm('Bu i≈ülemi silmek istediƒüinize emin misiniz?')) return;
      
      document.getElementById('syncIndicator').classList.remove('hidden');
      
      try {
        const { error } = await supabase.from('transactions').delete().eq('id', id);
        if (error) throw error;
        transactions = transactions.filter(t => t.id !== id);
        renderApp();
      } catch(e) {
        alert('Silme hatasƒ±: ' + e.message);
      }
      
      document.getElementById('syncIndicator').classList.add('hidden');
    }
  </script>
</body>
</html>
